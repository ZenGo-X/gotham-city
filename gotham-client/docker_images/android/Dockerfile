# syntax = docker/dockerfile:1.2
FROM rust:latest
ENV GMP_VERSION=6.2.1
ENV NDK_VERSION=21e
ENV MIN_SDK_VERSION=26
ENV ANDROID_NDK_HOME=/android-ndk/
ENV PATH="/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/:${PATH}"
ENV OPENSSL_VERSION=1.1.1n
ENV TARGET_CXXFLAGS=-mno-outline-atomics
ENV PKG_CONFIG_SYSROOT_DIR="${ANDROID_NDK_HOME}toolchains/llvm/prebuilt/linux-x86_64/sysroot"
RUN apt update && \
    wget https://dl.google.com/android/repository/android-ndk-r${NDK_VERSION}-linux-x86_64.zip && \
    unzip android-ndk-r*.zip && \
    rm android-ndk-r*.zip && \
    mv android-ndk-r* android-ndk && \
    rustup target add \
    aarch64-linux-android \
    armv7-linux-androideabi \
    x86_64-linux-android \
    i686-linux-android && \
    cargo install cargo-ndk && \
    cd / && \
    wget https://gmplib.org/download/gmp/gmp-${GMP_VERSION}.tar.lz && \
    apt install lzip && \
    tar -xvf ./gmp-*.tar.lz && \
    rm  gmp-*.tar.lz && \
    mv gmp-* gmp && \
    cd /gmp && \
    mkdir build && \
    cd build && \
    for i in armv7a-linux-androideabi aarch64-linux-android x86_64-linux-android; do \
    mkdir $i && \
    cd $i && \
    ../../configure --host=${i}${MIN_SDK_VERSION} CC=${i}${MIN_SDK_VERSION}-clang && \
    make -j 32 && \
    cd .. ;\
    done && \
    cd / && \
    wget https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz && \
    tar -xvf openssl-${OPENSSL_VERSION}.tar.gz && \
    rm openssl-${OPENSSL_VERSION}.tar.gz && \
    mv openssl-${OPENSSL_VERSION} openssl && \
    mkdir /openssl/build && \
    cd /openssl/build/ && \
    for i in android-arm64 android-arm android-x86_64; do \
    mkdir $i && \
    cd $i && \
    ../../Configure $i && \
    make -j 32 && \
    cd .. ;\
    done && \
    cd / && \
    cp -r /openssl/include/* ${ANDROID_NDK_HOME}toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/include/ && \
    cp -r /openssl/build/android-arm64/include/* ${ANDROID_NDK_HOME}toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/include/ && \
    cp /openssl/build/android-arm64/libssl.so ${ANDROID_NDK_HOME}toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/aarch64-linux-android && \
    cp /openssl/build/android-arm64/libcrypto.so ${ANDROID_NDK_HOME}toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/aarch64-linux-android && \
    cp /openssl/build/android-arm/libssl.so ${ANDROID_NDK_HOME}toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/arm-linux-androideabi/ && \
    cp /openssl/build/android-arm/libcrypto.so ${ANDROID_NDK_HOME}toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/arm-linux-androideabi/ && \
    cp /openssl/build/android-x86_64/libssl.so ${ANDROID_NDK_HOME}toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/x86_64-linux-android/ && \
    cp /openssl/build/android-x86_64/libcrypto.so ${ANDROID_NDK_HOME}toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/x86_64-linux-android/ && \
    cp /gmp/build/aarch64-linux-android/.libs/libgmp.so ${ANDROID_NDK_HOME}toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/aarch64-linux-android/ && \
    cp /gmp/build/armv7a-linux-androideabi/.libs/libgmp.so ${ANDROID_NDK_HOME}toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/arm-linux-androideabi/ && \
    cp /gmp/build/x86_64-linux-android/.libs/libgmp.so ${ANDROID_NDK_HOME}toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/x86_64-linux-android/
